<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="v_OkIhl-1XjKYm3MZSJoivLgfqE3N9Snb2bj2c9YDrw" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="search-engine,shodan,zoomeye,fofa,reconnaissance,资产探测,扫描,端口欺骗" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="在整个ATT&amp;amp;CK的链路中，资产扫描探测的结果对于最终的渗透效果有着重要的影响，对目标资产了解的越多，更容易分析出组织架构、脆弱点和突破点。为了减少扫描行为被防守队发现或封禁，Shodan, Fofa, Zoomeye等空间搜索引擎作为第三方的资产收录平台可以很好的辅助我们，免去扫描的步骤，直接搜索利用点。尤其是在攻防演练或者hw等时期，大量的蜜罐部署以及7*24小时的防守值班，任何轻微的">
<meta name="keywords" content="search-engine,shodan,zoomeye,fofa,reconnaissance,资产探测,扫描,端口欺骗">
<meta property="og:type" content="article">
<meta property="og:title" content="空间搜索引擎与端口扫描欺骗">
<meta property="og:url" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/index.html">
<meta property="og:site_name" content="empty_xl Blog">
<meta property="og:description" content="在整个ATT&amp;amp;CK的链路中，资产扫描探测的结果对于最终的渗透效果有着重要的影响，对目标资产了解的越多，更容易分析出组织架构、脆弱点和突破点。为了减少扫描行为被防守队发现或封禁，Shodan, Fofa, Zoomeye等空间搜索引擎作为第三方的资产收录平台可以很好的辅助我们，免去扫描的步骤，直接搜索利用点。尤其是在攻防演练或者hw等时期，大量的蜜罐部署以及7*24小时的防守值班，任何轻微的">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/syn_cookie.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/shodan_scan.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/initiative_scan.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/maybe_shodan.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/scan_80.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/passively_scan.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/asn.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/asn_search.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/mmh3.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/html_hash.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/icon_hash.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/hash_0.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_baidu.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_baidu_search.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_evil_server.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/dns_server_l.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/dns_0.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/ignore_a_record.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/stage.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/dig_baidu.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/nmap.jpg">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/port_spoof_1.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/port_spoof_2.png">
<meta property="og:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/shodan_filter.png">
<meta property="og:updated_time" content="2021-05-19T11:38:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="空间搜索引擎与端口扫描欺骗">
<meta name="twitter:description" content="在整个ATT&amp;amp;CK的链路中，资产扫描探测的结果对于最终的渗透效果有着重要的影响，对目标资产了解的越多，更容易分析出组织架构、脆弱点和突破点。为了减少扫描行为被防守队发现或封禁，Shodan, Fofa, Zoomeye等空间搜索引擎作为第三方的资产收录平台可以很好的辅助我们，免去扫描的步骤，直接搜索利用点。尤其是在攻防演练或者hw等时期，大量的蜜罐部署以及7*24小时的防守值班，任何轻微的">
<meta name="twitter:image" content="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/syn_cookie.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: 'QT63IJTEZX',
      apiKey: '39726b4e0e80a502f3d0a45f494af02f',
      indexName: 'blog.nyrae.icu',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/"/>





  <title>空间搜索引擎与端口扫描欺骗 | empty_xl Blog</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-90390918-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?edc3c09a0382806fc3a47d6c11483da0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">empty_xl Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Hacked By_ emm myself?</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="empty_xl">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="empty_xl Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">空间搜索引擎与端口扫描欺骗</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-05-19T19:38:43+08:00">
                2021-05-19
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2021-05-19T19:38:43+08:00">
                2021-05-19
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/scanning/" itemprop="url" rel="index">
                    <span itemprop="name">scanning</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在整个<code>ATT&amp;CK</code>的链路中，资产扫描探测的结果对于最终的渗透效果有着重要的影响，对目标资产了解的越多，更容易分析出组织架构、脆弱点和突破点。为了减少扫描行为被防守队发现或封禁，<code>Shodan</code>, <code>Fofa</code>, <code>Zoomeye</code>等空间搜索引擎作为第三方的资产收录平台可以很好的辅助我们，免去扫描的步骤，直接搜索利用点。尤其是在攻防演练或者hw等时期，大量的蜜罐部署以及7*24小时的防守值班，任何轻微的可疑扫描行为都会引起防守队的察觉，从而被封IP。因此利用好第三方搜索引擎的结果，可以让我们更加容易和灵活的进行边界突破。本文将介绍空间搜索引擎的原理及一些常见特性，以及可能的对抗方式——扫描欺骗。</p>
<a id="more"></a>
<p>首先第一个问题，这些搜索引擎的作用是什么？根据个人经验，我将其划分为以下4类。</p>
<ul>
<li>资产发现与统计</li>
<li>基于版本、banner的漏洞利用</li>
<li>脆弱性信息发现 (包括弱口令、回显包含hacked by xx)</li>
<li>0day漏洞影响评估</li>
</ul>
<p>在本篇文章中，我们主要关注与原理层面的内容并尝试通过各种方式验证我们的猜测。除此之外，一些常用的用法及特性放在了附录中，可以作为清单进行查询。</p>
<h3 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h3><p>首先是第一阶段，端口扫描。大多数搜索引擎都会声称他们的产品扫描全网整个IPv4的地址空间并进行识别收录，根据我的实际测试结果，在公网服务器上部署任意一个服务，基本上这些引擎的数据库都会在1天之内进行收录，效率还是蛮高的。那么，他们是如果对整个IPv4空间进行扫描的？根据一些公开的分享和业界对于端口扫描的常见方式，基于无状态扫描的高效性，基本可以确定这些搜索引擎也是使用类似<code>zmap</code>,<code>masscan</code>这样的工具进行端口开放性探测，之后在第一步的基础上，利用<code>nmap</code>等工具进行服务的版本探测、指纹识别。</p>
<p>对于TCP的服务扫描，其原理基本分为两大类:</p>
<ol>
<li>基于TCP三次握手机制</li>
<li>基于RFC规定实现的特性</li>
</ol>
<p>使用第一类方式进行扫描是基于握手机制，客户端发送SYN包，服务端返回SYN+ACK包进行确认，常见的有SYN扫描(半连接扫描)、connect扫描、无状态扫描；第二类大多数是基于TFC的规定(当数据包中没有SYN/ACK/RST标志时，端口关闭的会导致服务器返回一个RST包，而被过滤或开放不会有任何回包)，例如常见的TCP window/ACK扫描，TCP Xmas/FIN/null/Maimon 扫描。第二类的扫描机制无法有效确认出端口是否开放，所以在全网量级的扫描活动中并不常见，大部分还是基于第一类的三次握手原理进行。</p>
<blockquote>
<p>Zmap and masscan are well-known port scanning tools, which claim to scan the entire network ports within 45 minutes. The reason why the speed is so fast is that it uses a stateless scanning method.<br>As you know, the theoretical basis of port scanning is that the server returns different data for TCP packets with different flags.The client sends an SYN packet with the special seq number value. After receiving this packet, the opened server responds to the SYN+ACK packet and sets the ack number to seq+1. In the end, the client responds to an ACK packet to complete the connection establishment. This process is also the familiar TCP Three-way Handshake.<br>Note here that the value of the ack field in the response data packet response by the server can be predicted, so the process of sending SYN packet and receiving SYN+ACK packet can be separated by two programs to improve the efficiency of the scanning, and we could set a special sequence number value to indicate different scanned targets.The figure below is the implementation in masscan.</p>
</blockquote>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/syn_cookie.png" alt="syn_cookie" title="syn_cookie">
<p>为了验证我们的猜测，我们在公有云部署了一些蜜罐来尝试捕获这些扫描的行为。在蜜罐上开放了TOP 1000的端口并剔除掉80,443,3306等极其常见的端口，剔除的目的是为了减少蠕虫、批量化攻击脚本等行为对我们带来的干扰。除了被动的等待搜索引擎对我们的探测之外，我们还利用shodan提供的主动扫描能力 <a href="https://help.shodan.io/the-basics/on-demand-scanning" target="_blank" rel="external"><code>Shodan On-demand Scaning</code></a>主动发起探测.</p>
<p>根据扫描的结果，我们发现了一些有意思的东西。首先我们来看看主动扫描的结果。(我不知道为什么会一直显示这个信息，及时去扫描新的开放的端口)</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/shodan_scan.png" alt="shodan_scan" title="shodan_scan">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/initiative_scan.png" alt="active_scan" title="active_scan">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/maybe_shodan.png" alt="maybe it's the shodan scanner's IP" title="maybe it's the shodan scanner's IP">
<p>在我们主动提交扫描任务后，我们在服务器上抓包结果如图所示。根据ip搜索的结果，我们基本可以确认64开头的ip属于<code>Shodan</code>.我们的服务器大概收到了总过500个包的样子，剔除掉banner扫描的结果，差不多只有300个包的样子。从扫描的结果来看，基本可以看出来shodan的扫描方式是类似zmap、masscan这样的无状态扫描方式——使用syn包扫描判断端口开放与否。不同的是，在shodan扫描包的填充字段，<code>ip_id</code> 和 <code>window_size</code>都是随机值，而<code>zmap</code>的<code>ip_id</code>是54321, <code>window_size</code>是 65535。除此之外，可以看到，在主动扫描任务重，对于不同端口的扫描使用的是同一ip源。这里顺便提一句，常见的扫描工具，<code>nmap</code>,<code>zmap</code>,<code>masscan</code>在包层面有一定特征:</p>
<ul>
<li>nmap: 默认 window_size:1024</li>
<li>zmap: 默认 window_size:65535 / ip_id:54321</li>
<li>masscan: 默认 window_size:1200</li>
</ul>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/scan_80.png" alt="scan the 80 port" title="scan the 80 port">
<p>当确认某一端口确实是开放时，他将会利用一些探测策略来进行服务版本探测。可以看到，对于80端口也就是常见的HTTP服务，其会扫描主页、<code>robots.txt</code>、<code>sitemap</code>文档,<code>icon</code>图标等。值得注意的是，在版本探测的时候，<code>window_size</code>会被设置为固定值64240。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/passively_scan.png" alt="passive_scan" title="passive_scan">
<p>如图所示，是蜜罐捕获的被动扫描结果，扫描的字段和填充值和我们主动扫描的结果看起来差不多。不一样的是，并没有发现同一个ip扫描大量端口的行为，这也很容易理解，被动扫描为了不触发一些安全设备，通常都会将全网的扫描任务分布式的下发到不同的节点，并由不同的ip进行扫描任务，所以对特定的服务期而言，不会在短时间内收到来自同一个IP的大量扫描行为。我们将全端口进行了开放，一天下来，只有很少一部分端口有被扫到。</p>
<h3 id="版本探测"><a href="#版本探测" class="headerlink" title="版本探测"></a>版本探测</h3><p>在版本探测阶段，<code>Shodan</code>和<code>Nmap</code>一样维护这一大批版本探测策略，根据公开的信息显示，其支持超过200种协议类型的探测。<code>Shodan</code>向不同端口发送不同类型的探测包，然后根据服务端返回的信息内容进行解析，从而判断出目标服务端口运行的服务类型及版本。本文不再关心这些版本探测的策略，如果有兴趣可以去看各类服务探测的文章或者nmap手册。</p>
<p>在这里 <a href="http://plcscan.org/blog/2020/11/research-report-of-renowned-internet-census-organization-shodan/" target="_blank" rel="external">plcscan.org</a>, 你可以看到他们列举了shodan最为常见使用的协议，包括很多工控协议。</p>
<h3 id="一些特性"><a href="#一些特性" class="headerlink" title="一些特性"></a>一些特性</h3><p>介绍完他们的基本扫描原理，这里我们介绍几个比较有意思的字段。</p>
<h4 id="ASN"><a href="#ASN" class="headerlink" title="ASN"></a>ASN</h4><p>当你需要评估的网络达到一定的规模时，基于IP和IP段的搜索方式显然无法有效的帮助我们来进行识别和评估。这时也许 <code>ASN</code> 字段可以帮你快速评估整个组织的设备情况。</p>
<blockquote>
<p>An autonomous system (AS) is a collection of connected Internet Protocol (IP) routing prefixes under the control of one or more network operators on behalf of a single administrative entity or domain that presents a common, clearly defined routing policy to the Internet.</p>
<p>A regional Internet registry (RIR) is an organization that manages the allocation and registration of Internet number resources within a region of the world. Internet number resources include IP addresses and autonomous system (AS)) numbers.</p>
</blockquote>
<p>你可以简单的理解为5个区域互联网注册管理机构管理着整个世界的IP地址空间。当有资格的组织或企业想要申请管理部分公网IP时，向所属地区的注册管理机构进行申请，申请成功后便会获取特定IP网段的所有权并有权决定这些网段如何进行内部分配及使用。这些IP段构成了一个自治系统，其编号被称为<code>asn</code>编号。</p>
<p>当属于不同<code>asn</code>系统的IP需要进行通信时，往往会通过最短的链路进行数据通信，这也就是我们熟悉的BGP协议所做的工作了。举个例子，在天朝，移动、联通、电信可以看成三个不同的ASN网络，他们内部的节点互联的速度很快，而互访的体验就会很差，这也就是我们经常会听见BGP线路加速的原因。</p>
<p>通常情况下，大型组织或企业所拥有的<code>asn</code>是有限的，和IP段的量级相比差很多，因此可以通过<code>asn</code>号快速方便的进行资产的搜索。这里推荐一个网站用于<code>asn</code>信息的查询, <a href="https://hackertarget.com/as-ip-lookup/" target="_blank" rel="external">hackertarget</a>. 假设我们今天需要对腾讯在公网的端口暴露情况进行分析，我们可以使用这个网站查询到所有归属于<code>Tencent</code>的<code>asn</code>号并使用搜索引擎进行搜索。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/asn.jpg" alt="search result" title="search result">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/asn_search.jpg" alt="search via ASN" title="search via ASN">
<p>与 <code>org</code>, <code>isp</code>, <code>ip</code> 等字段对比, 通过<code>asn</code> 的方式获取数据显得更加的高效。但同样存在一个问题，一般大型的组织会对外提供服务，因此通过<code>asn</code>号获取的资产有可能是其客户的资产，这一点可能需要通过其他纬度来进行剔除。</p>
<h4 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h4><p>在翻搜索引擎的手册中，你可以看到一个有意思的事情:所有引擎会去计算banner的哈希值、icon的哈希值甚至http包的哈希值，记为<code>hash</code>、 <code>http.favicon.hash</code>或者<code>http.html.hash</code>. 这个哈希值可以用来快速的筛选过滤出/排除具有相同内容特征的服务器，这里使用<code>mmh3</code>哈希算法来进行内容的哈希是从计算与存储的高效性方面来考虑的。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/mmh3.jpg" alt="mmh3" title="mmh3">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/html_hash.jpg" alt="html_hash" title="html_hash">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/icon_hash.jpg" alt="icon_hash" title="icon_hash">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/hash_0.jpg" alt="无banner数据服务器" title="无banner数据服务器">
<h4 id="JARM"><a href="#JARM" class="headerlink" title="JARM"></a>JARM</h4><p>目前越来越多的Web站点采用SSL/TLS的方式来保护通信中的数据安全不被第三方中间人进行嗅探，而由于TLS在握手阶段客户端和服务端会发送大量自己支持的加密算法套件、哈希方式、压缩方式并进行协商选择，这部分数据又是明文信息，而相同的服务、程序对于相同的请求选择偏好是固定的，因此这个规律也被用来生成TLS指纹，用来标识一类具有相同SSL/TLS属性配置的程序。对于SSL/TLS的协议分析在这里不再赘述，有兴趣的可以看我之前的<a href="https://blog.nyrae.icu/blog/ssl/">TLS协议分析</a>以及对于<a href="https://blog.nyrae.icu/blog/encrypted-traffic-analysis/">SSL/TLS指纹分析</a>的内容。</p>
<p>JARM指纹也是如此，相比于JA3/JA3S，JARM是用来识别特定配置的TLS服务器。其原理是主动发送10个精心构造的TLS client握手包，根据服务端返回的结果进行指纹计算。通常相同配置的TLS服务器返回的指纹是一致的，因此可以用来快速的识别一些企业特定的服务器。这些精心构造的握手包包括是否支持TLS1.3,不同的密码学套件顺序如何选择，异常套件的处理方式等等</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm.png" alt="JARM" title="JARM">
<p>最终其会根据10个回复的server_hello数据包中的字段进行指纹计算，每次扫描取的内容为<code>密码学套件|TLS版本|ALPN协议信息|扩展字段</code></p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_baidu.png" alt="baidu_JARM" title="baidu_JARM">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_baidu_search.png" alt="JARM_search_res" title="JARM_search_res">
<p>JARM除了用于识别相同配置的TLS服务器，其也可以用于识别恶意服务器(如果恶意服务器是自行搭建的话)，如下图是官方给出的常见恶意server的JARM，如果你按照这个值去搜索引擎中搜索，你会发现有一大堆服务器，都是恶意的嘛？当然不是，其主要原因是像这些知名C2工具不会自己去实现一个中控web服务器，而是内置了特定版本的常见web服务器，例如没有记错的话，<code>Metasploit</code>使用<code>nginx</code>而<code>Cobalt Strike</code>使用<code>tomcat</code>，因此进行搜索时，会混入大量正常的服务器。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/jarm_evil_server.png" alt="evil_JARM_server" title="evil_JARM_server">
<h4 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h4><p>也是一个比较新的特性，同JARM的目的一样，也是为了去识别恶意的服务器，不同的是，dig是为了识别恶意的<code>Cobalt Strike DNS</code>服务器。如下图所示，为典型的带一个<code>DNS Redirector``的恶意DNS服务器链路。使用Redirector</code>的好处是即使被防守方发现通过DNS隧道进行通信导致ip被ban,也可以很轻松的通过域名解析的修改来进行服务器的切换，从而保住真实的<code>DNS Listener</code>不被发现。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/dns_server_l.png" alt="DNS_Listener" title="DNS_Listener">
<p>那么如果去发现真实的DNS Listener呢？<code>Cobalt Strike</code>的DNS Listener有一个特性，即对于不关心的域名会选择忽略并返回一个固定的ip值，这个ip默认为<code>0.0.0.0</code>,这一点可以从其代码中看出</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/dns_0.png" alt="BeaconDNS" title="BeaconDNS">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/ignore_a_record.png" alt="ignore_invalid_domain" title="ignore_invalid_domain">
<p>而当符合请求的域名包含特定的前缀时，CS会返回shellcode:</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/stage.png" alt="dns_shellcode" title="dns_shellcode">
<p>因此，如果DNS Listener的端口暴露在公网可访问，通过解析不同域名，如果返回值相同或均为0.0.0.0,则很有可能是<code>cobalt strike</code>的真实DNS服务器.</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/dig_baidu.png" alt="evil_server" title="evil_server">
<h3 id="端口扫描欺骗"><a href="#端口扫描欺骗" class="headerlink" title="端口扫描欺骗"></a>端口扫描欺骗</h3><p>我们现在来换个角度。如果你是大型组织的负责人，这些搜索引擎对于的价值是什么？可能很大概率你并不想让第三方平台对你公网暴露的资产进行收录，因为这样攻击者会更加容易的进行入口突破。当然最简单的方式是关闭所有对外开放的端口，但这也显然不太现实。因此，端口扫描欺骗也许是有效缓解并增加攻击者成本的有效方式之一。通过端口欺骗技术，可以向攻击者的扫描结果数据库或搜索引擎的数据库中插入大量无效的开放信息甚至banner信息，从而干扰并浪费攻击者的精力与资源.</p>
<p>根据我们之前提到的内容，端口扫描的逻辑是根据三次握手的回包数据来判断是否端口开放的。当一个端口关闭时，系统会回复一个<code>reset</code>包作为响应。如果我们根据客户端的请求构造一个<code>syn+ack</code>包并比服务端真实发送的<code>reset</code>更快返回给客户端，客户端就会认为这个端口是开放的，而忽略掉真实服务器发送来的那个<code>reset</code>包。</p>
<p>我们来验证下我们的想法，我们在公网环境下部署了一套欺骗程序。程序主要分为两部分， 使用iptables进行引流和流量监控<code>syn</code>包并返回对应的假的<code>syn+ack</code> 包.当然你也可以使用开源的程序(<a href="https://github.com/drk1wi/portspoof" target="_blank" rel="external">portspoof</a>).</p>
<p>做完了这些，我们对我们部署的服务器使用nmap、zmap、masscan进行了一次端口扫描。如图所示，一切都都跟预想的一样，可以成功的欺骗客户端的结果。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/nmap.jpg" alt="nmap_scan_result" title="nmap_scan_result">
<p>欺骗完扫描工具，还剩下最后一个问题，是否对搜索引擎也有效呢？答案是肯定的，但是不同的引擎的收录策略会有一些不同，且会存在一些确定的特征。</p>
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/port_spoof_1.png" alt="端口欺骗" title="端口欺骗">
<img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/port_spoof_2.png" alt="banner欺骗" title="banner欺骗">
<h3 id="附录-使用速查手册"><a href="#附录-使用速查手册" class="headerlink" title="附录(使用速查手册)"></a>附录(使用速查手册)</h3><h4 id="Shodan"><a href="#Shodan" class="headerlink" title="Shodan"></a>Shodan</h4><img src="/blog/some-analysis-of-the-Internet-spatial-search-engine/shodan_filter.png" alt="shodan filter fields" title="shodan filter fields">
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Example</div><div class="line"><span class="symbol"></span></div><div class="line">port:<span class="number">22</span>,<span class="number">80</span>,<span class="number">8080</span>,<span class="number">443</span> <span class="string">country:</span>CN,JP -<span class="string">hash:</span><span class="number">-0</span></div><div class="line"></div><div class="line">ssl.<span class="string">version:</span>tlsv1<span class="number">.3</span> HTTP -<span class="string">port:</span><span class="number">443</span></div><div class="line"><span class="symbol"></span></div><div class="line">port:<span class="number">80</span> <span class="string">country:</span>CN http.<span class="string">title:</span><span class="string">"Apache2 Ubuntu Default Page"</span></div><div class="line"><span class="symbol"></span></div><div class="line">port:<span class="number">8080</span> <span class="string">country:</span>CN http.<span class="string">title:</span><span class="string">"Apache Tomcat/"</span> http.favicon.<span class="string">hash:</span><span class="number">-297069493</span></div></pre></td></tr></table></figure>
<h4 id="Fofa"><a href="#Fofa" class="headerlink" title="Fofa"></a>Fofa</h4><ul>
<li>title=”beijing”</li>
<li>header=”abc”</li>
<li>body=”abc”</li>
<li>domain=”qq.com”</li>
<li>host=”.gov.cn”</li>
<li>icp=”京ICP证030173号”</li>
<li>js_name=”js/jquery.js”</li>
<li>js_md5=”82ac3f14327a8b7ba49baa208d4eaa15”</li>
<li>icon_hash=”-247388890”</li>
<li>port=”443”</li>
<li>ip=”1.1.1.1”</li>
<li>ip=”220.181.111.1/24”</li>
<li>status_code=”402”</li>
<li>protocol=”https”</li>
<li>city=”Hangzhou”</li>
<li>region=”Zhejiang”</li>
<li>country=”CN”</li>
<li>cert=”google”</li>
<li>cert.subject=”Oracle Corporation”</li>
<li>cert.issuer=”DigiCert”</li>
<li>cert.is_valid=true</li>
<li>banner=users &amp;&amp; protocol=ftp</li>
<li>is_fraud=false</li>
<li>is_honeypot=false</li>
<li>type=service</li>
<li>os=windows</li>
<li>server==”Microsoft-IIS/7.5”</li>
<li>app=”Apache”</li>
<li>after=”2017” &amp;&amp; before=”2017-10-01”</li>
<li>asn=”19551”</li>
<li>org=”Amazon.com, Inc.”</li>
<li>base_protocol=”udp”</li>
<li>is_ipv6=true</li>
<li>is_domain=true</li>
<li>ip_ports=”80,443” 或者 ports=”80,443”</li>
<li>ip_country=”CN”</li>
<li>ip_region=”Zhejiang”</li>
<li>ip_city=”Hangzhou”</li>
<li>ip_after=”2019-01-01”</li>
<li>ip_before=”2019-01-01”</li>
<li>port_size=”6”</li>
<li>port_size_gt=”6”</li>
<li>port_size_lt=”12”</li>
<li>ip_ports=”80,161”</li>
</ul>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">title</span>=<span class="string">"powered by"</span> &amp;&amp; <span class="built_in">title</span>!=<span class="string">"discuz"</span></div><div class="line">body=<span class="string">"content=WordPress"</span> || (<span class="built_in">header</span>=<span class="string">"X-Pingback"</span> &amp;&amp; <span class="built_in">header</span>=<span class="string">"/xmlrpc.php"</span> &amp;&amp; body=<span class="string">"/wp-includes/"</span>) &amp;&amp; host=<span class="string">"gov.cn"</span></div></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:</strong>
    empty_xl
  </li>
  <li class="post-copyright-link">
    <strong>Post link:</strong>
    <a href="https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/" title="空间搜索引擎与端口扫描欺骗">https://blog.nyrae.icu/blog/some-analysis-of-the-Internet-spatial-search-engine/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice: </strong>
    All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="external nofollow" target="_blank">CC BY-NC-ND 4.0</a> unless stating additionally.
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Search-Engine/" rel="tag"><i class="fa fa-tag"></i> Search-Engine</a>
          
            <a href="/tags/network-security/" rel="tag"><i class="fa fa-tag"></i> network security</a>
          
            <a href="/tags/port-spoofing/" rel="tag"><i class="fa fa-tag"></i> port spoofing</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/gitlab-djvu-rce/" rel="next" title="Gitlab 13.10.2 Remote Code Execution()">
                <i class="fa fa-chevron-left"></i> Gitlab 13.10.2 Remote Code Execution()
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/encrypted-traffic-analysis/" rel="prev" title="encrypted_traffic_analysis">
                encrypted_traffic_analysis <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
    <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
    <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
    <script>
    var gitment = new Gitment({
      // 根据文章标题设置唯一评论id
    // id: '', // optional
    owner: 'emptyxl',
    repo: 'emptyxl.github.io',
    oauth: {
      client_id: 'fa7413e3c0207a96ae03',
      client_secret: 'a599fef18d25ba5c813d2e437260892e146462a2',
      }
    })
    gitment.render('comments')
    </script>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="empty_xl" />
          <p class="site-author-name" itemprop="name">empty_xl</p>
           
              <p class="site-description motion-element" itemprop="description">Hacked By_ EmPTy_xL../ security blog </p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">73</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/emptyxl" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      Github
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="/mail/index.html" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                    
                      E-Mail
                    
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-nd.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#端口扫描"><span class="nav-number">1.</span> <span class="nav-text">端口扫描</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#版本探测"><span class="nav-number">2.</span> <span class="nav-text">版本探测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些特性"><span class="nav-number">3.</span> <span class="nav-text">一些特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ASN"><span class="nav-number">3.1.</span> <span class="nav-text">ASN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hash"><span class="nav-number">3.2.</span> <span class="nav-text">hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JARM"><span class="nav-number">3.3.</span> <span class="nav-text">JARM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dig"><span class="nav-number">3.4.</span> <span class="nav-text">dig</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#端口扫描欺骗"><span class="nav-number">4.</span> <span class="nav-text">端口扫描欺骗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#附录-使用速查手册"><span class="nav-number">5.</span> <span class="nav-text">附录(使用速查手册)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shodan"><span class="nav-number">5.1.</span> <span class="nav-text">Shodan</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Fofa"><span class="nav-number">5.2.</span> <span class="nav-text">Fofa</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    
    &emsp;&emsp;|&emsp;
  </span>
  <span class="author" itemprop="copyrightHolder">empty_xl</span>
</div>


<div class="powered-by">
  
  Power &mdash; Hexo
</div>

<div class="theme-info">
  
  Theme &mdash; NexT.Mist
</div>
<div>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
